<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>入社手続き入力フォーム - ステップ1/3</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>入社手続き入力フォーム (ステップ1/3)</h1>
        <div class="debug-controls">
            <button id="dev_fill_form_btn">テストデータ入力</button>
            <button id="dev_reset_form_btn">フォーム入力リセット</button>
            <button id="dev_clear_storage_btn">LocalStorageクリア</button>
        </div>

        <form action="#" method="post" id="onboardingFormPage1">
            <!-- 基本情報 -->
            <fieldset class="form-section">
                <legend><h2>入社手続き入力フォーム</h2></legend>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="last_name">姓</label>
                        <input type="text" id="last_name" name="last_name" value="山田">
                    </div>
                    <div class="form-group">
                        <label for="first_name">名</label>
                        <input type="text" id="first_name" name="first_name" value="太郎">
                    </div>
                    <div class="form-group">
                        <label for="last_name_kana">姓（ヨミガナ）</label>
                        <input type="text" id="last_name_kana" name="last_name_kana" value="ヤマダ">
                    </div>
                    <div class="form-group">
                        <label for="first_name_kana">名（ヨミガナ）</label>
                        <input type="text" id="first_name_kana" name="first_name_kana" value="タロウ">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="gender">性別</label>
                        <select id="gender" name="gender">
                            <option value="">選択してください</option>
                            <option value="male" selected>男性</option>
                            <option value="female">女性</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birth_date">生年月日</label>
                        <input type="date" id="birth_date" name="birth_date" value="1990-01-01">
                    </div>
                </div>
                <div class="form-group">
                    <label for="department">所属事業所名（編集不可）</label>
                    <input type="text" id="department" name="department" value="ONOKICHI事業所" readonly class="readonly-field">
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="phone_number">電話番号</label>
                        <input type="tel" id="phone_number" name="phone_number" placeholder="例:03-0000-0000" value="03-1234-5678">
                        <p class="description">半角入力 (例)03-0000-0000</p>
                    </div>
                    <div class="form-group">
                        <label for="mobile_phone_number">携帯電話番号</label>
                        <input type="tel" id="mobile_phone_number" name="mobile_phone_number" class="required-field" placeholder="例:080-0000-0000">
                        <p class="description">半角入力 (例)080-0000-0000</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="email">個人メールアドレス</label>
                    <input type="email" id="email" name="email" class="required-field">
                    <p class="description">このメールアドレスはログイン時に必要となります。</p>
                </div>
                <div class="form-group">
                    <label>国籍</label>
                    <div class="radio-group">
                        <label><input type="radio" name="nationality" value="japanese" checked> 日本人</label>
                        <label><input type="radio" name="nationality" value="foreign"> 外国籍</label>
                    </div>
                </div>
                <div class="form-group" id="residence_status_group" style="display:none;"> <!-- JSで表示制御 -->
                    <label for="residence_status">滞在区分</label>
                    <select id="residence_status" name="residence_status">
                        <option value="">選択してください</option>
                        <option value="student">留学生</option>
                        <option value="family_stay">家族滞在</option>
                        <option value="specified_activities">特定活動</option>
                        <option value="other_permanent_resident">上記以外(外国籍永住者等)</option>
                    </select>
                </div>
            </fieldset>

            <!-- 契約書類 -->
            <fieldset class="form-section" id="contract_documents_section">
                <legend><h2>契約書類</h2></legend>
                <div class="inline-fields">
                    <div class="document-box clickable-document" data-modal-target="#employmentContractModal" data-contract-id="employmentContract" data-contract-name="雇用契約書 兼 雇入通知書">
                        <span class="document-icon">📄</span>
                        <p>(入社)雇用契約書 兼<br>雇入通知書</p>
                        <p class="contract-status status-pending" id="employmentContractStatus">（未合意）</p>
                        <div class="document-box-post-actions" id="employmentContractPostActions" style="display:none;">
                            <button type="button" class="action-btn-small print-contract-btn">
                                <svg viewBox="0 0 20 20"><path d="M16 10c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1zM5 13h4c.55 0 1 .45 1 1s-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1zm12-8H3c-.55 0-1 .45-1 1v2H1c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1zm-1 10H2V7h1V4h14v9zM6 2h8v2H6V2z"/></svg>
                                印刷
                            </button>
                            <button type="button" class="action-btn-small download-contract-btn">
                                <svg viewBox="0 0 20 20"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
                                ダウンロード
                            </button>
                        </div>
                    </div>
                    <div class="document-box clickable-document" data-modal-target="#guaranteeContractModal" data-contract-id="guaranteeContract" data-contract-name="契約書 兼 身元保証書">
                        <span class="document-icon">📄</span>
                        <p>契約書 兼 身元保証書</p>
                         <p class="contract-status status-pending" id="guaranteeContractStatus">（未合意）</p>
                         <div class="document-box-post-actions" id="guaranteeContractPostActions" style="display:none;">
                            <button type="button" class="action-btn-small print-contract-btn">
                                <svg viewBox="0 0 20 20"><path d="M16 10c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1zM5 13h4c.55 0 1 .45 1 1s-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1zm12-8H3c-.55 0-1 .45-1 1v2H1c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1zm-1 10H2V7h1V4h14v9zM6 2h8v2H6V2z"/></svg>
                                印刷
                            </button>
                            <button type="button" class="action-btn-small download-contract-btn">
                                <svg viewBox="0 0 20 20"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
                                ダウンロード
                            </button>
                        </div>
                    </div>
                </div>
                <!-- 外国籍の場合の追加書類用コンテナ -->
                <div id="foreign_documents_container" class="inline-fields" style="display:none; margin-top:15px; gap: 10px; flex-wrap: wrap;">
                    <!-- JSでここに在留カードとパスポートの項目を追加 -->
                </div>
            </fieldset>

            <!-- 現住所 -->
            <fieldset class="form-section">
                <legend><h2>現住所</h2></legend>
                <div class="postal-code-group">
                    <div class="form-group">
                        <label for="postal_code">住所(郵便番号)</label>
                        <input type="text" id="postal_code" name="postal_code" placeholder="例:1000001 または 100-0001" maxlength="8">
                    </div>
                    <button type="button" class="action-button-style" id="search_address_btn">住所検索</button>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="prefecture">住所(都道府県)</label>
                        <input type="text" id="prefecture" name="prefecture" placeholder="例:東京都">
                    </div>
                     <div class="form-group">
                        <label for="city">住所(市区町村)</label>
                        <input type="text" id="city" name="city" placeholder="例:千代田区千代田">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="address_line1">住所(丁目・番地)</label>
                        <input type="text" id="address_line1" name="address_line1" placeholder="例:1-1">
                    </div>
                    <div class="form-group">
                        <label for="address_line2">住所(建物名・部屋番号)</label>
                        <input type="text" id="address_line2" name="address_line2" placeholder="例:〇〇ビル101号室">
                    </div>
                </div>
                 <div class="form-group">
                    <label for="address_kana">住所(ヨミガナ)</label>
                    <input type="text" id="address_kana" name="address_kana" placeholder="例:トウキョウトチヨダクチヨダ">
                </div>
            </fieldset>

            <!-- 緊急連絡先 -->
            <fieldset class="form-section">
                <legend><h2>緊急連絡先</h2></legend>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_last_name">(姓)</label>
                        <input type="text" id="emergency_last_name" name="emergency_last_name" placeholder="例: 鈴木">
                    </div>
                    <div class="form-group">
                        <label for="emergency_first_name">(名)</label>
                        <input type="text" id="emergency_first_name" name="emergency_first_name" placeholder="例: 花子">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_last_name_kana">(姓:ヨミガナ)</label>
                        <input type="text" id="emergency_last_name_kana" name="emergency_last_name_kana" placeholder="例: スズキ">
                    </div>
                    <div class="form-group">
                        <label for="emergency_first_name_kana">(名:ヨミガナ)</label>
                        <input type="text" id="emergency_first_name_kana" name="emergency_first_name_kana" placeholder="例: ハナコ">
                    </div>
                </div>
                <div class="postal-code-group">
                    <div class="form-group">
                        <label for="emergency_postal_code">住所(郵便番号)</label>
                        <input type="text" id="emergency_postal_code" name="emergency_postal_code" placeholder="例: 1000002 または 100-0002" maxlength="8">
                    </div>
                    <button type="button" class="action-button-style" id="search_emergency_address_btn">住所検索</button>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_prefecture">住所(都道府県)</label>
                        <input type="text" id="emergency_prefecture" name="emergency_prefecture" placeholder="例: 東京都">
                    </div>
                     <div class="form-group">
                        <label for="emergency_city">住所(市区町村)</label>
                        <input type="text" id="emergency_city" name="emergency_city" placeholder="例: 千代田区皇居外苑">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_address_line1">住所(丁目・番地)</label>
                        <input type="text" id="emergency_address_line1" name="emergency_address_line1" placeholder="例: 1-2">
                    </div>
                    <div class="form-group">
                        <label for="emergency_address_line2">住所(建物名・部屋番号)</label>
                        <input type="text" id="emergency_address_line2" name="emergency_address_line2" placeholder="例: パレスビル202号室">
                    </div>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="emergency_phone">(電話番号)</label>
                        <input type="tel" id="emergency_phone" name="emergency_phone" placeholder="例: 090-1111-2222">
                        <p class="description">半角入力 (例)090-1111-2222</p>
                    </div>
                    <div class="form-group">
                        <label for="emergency_relationship">(続柄)</label>
                        <select id="emergency_relationship" name="emergency_relationship">
                            <option value="">選択してください</option>
                            <option value="parent">親</option>
                            <option value="spouse">配偶者</option>
                            <option value="child">子</option>
                            <option value="sibling">兄弟姉妹</option>
                            <option value="other_relative">その他親族</option>
                            <option value="friend">友人</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- 通勤手当 -->
            <fieldset class="form-section">
                <legend><h2>通勤手当</h2></legend>
                <div class="form-group">
                    <label>通勤手段</label>
                    <div class="radio-group">
                        <label><input type="radio" name="commute_method" value="public_transport" checked> 公共交通</label>
                        <label><input type="radio" name="commute_method" value="car"> マイカー</label>
                        <label><input type="radio" name="commute_method" value="motorcycle"> バイク</label>
                        <label><input type="radio" name="commute_method" value="moped"> 原付</label>
                        <label><input type="radio" name="commute_method" value="bicycle"> 自転車</label>
                        <label><input type="radio" name="commute_method" value="walk"> 徒歩</label>
                    </div>
                </div>
                
                <div class="form-group" id="commute_route_map_display_area" style="display:none; margin-top:20px;">
                    <label>通勤経路確認</label>
                    <iframe id="google_maps_route_iframe" width="100%" height="400" style="border:1px solid #ccc; border-radius:4px;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                    <button type="button" id="reflect_route_info_btn" class="action-button-style" style="margin-top:10px; display:none; background-color: #28a745;">表示された経路情報をフォームに反映</button>
                    <p class="description">上記は現住所と事業所「東京都千代田区大手町1－1－3」間の経路の目安です。<br>実際の所要時間や運賃と異なる場合がありますので、必要に応じて各入力欄で調整してください。</p>
                </div>

                <!-- 公共交通選択の場合 -->
                <div id="commute_public_transport_section" class="commute-method-specific-section">
                    <h3>公共交通</h3>
                    <div class="inline-fields">
                        <div class="form-group">
                            <label for="public_commute_method_detail">通勤手段詳細</label>
                            <select id="public_commute_method_detail" name="public_commute_method_detail">
                                <option value="">--選択してください--</option>
                                <option value="train">電車</option>
                                <option value="bus">バス</option>
                                <option value="train_bus">電車・バス</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="public_start_date">利用開始日</label>
                            <input type="date" id="public_start_date" name="public_start_date">
                        </div>
                    </div>
                    <div class="inline-fields">
                         <div class="form-group">
                            <label for="public_distance">通勤距離(片道)/km</label>
                            <input type="number" id="public_distance" name="public_distance" step="0.1" placeholder="例: 10.5">
                        </div>
                        <div class="form-group">
                            <label for="public_duration">所要時間(片道)</label>
                            <input type="text" id="public_duration" name="public_duration" placeholder="例: 60分">
                        </div>
                    </div>
                    
                    <h4>利用交通機関詳細</h4>
                    <div class="inline-fields">
                        <div class="form-group">
                            <label for="transport_company_1">利用機関 会社・路線名1</label>
                            <input type="text" id="transport_company_1" name="transport_company_1" placeholder="例: JR山手線">
                        </div>
                        <div class="form-group">
                            <label for="transport_section_1">利用区間1</label>
                            <input type="text" id="transport_section_1" name="transport_section_1" placeholder="例: 新宿駅 - 東京駅">
                        </div>
                    </div>
                    <div class="inline-fields">
                        <div class="form-group">
                            <label for="transport_company_2">利用機関 会社・路線名2</label>
                            <input type="text" id="transport_company_2" name="transport_company_2" placeholder="例: 東京メトロ丸ノ内線">
                        </div>
                        <div class="form-group">
                            <label for="transport_section_2">利用区間2</label>
                            <input type="text" id="transport_section_2" name="transport_section_2" placeholder="例: 東京駅 - 大手町駅">
                        </div>
                    </div>
                     <div class="inline-fields">
                        <div class="form-group">
                            <label for="transport_company_3">利用機関 会社・路線名3</label>
                            <input type="text" id="transport_company_3" name="transport_company_3">
                        </div>
                        <div class="form-group">
                            <label for="transport_section_3">利用区間3</label>
                            <input type="text" id="transport_section_3" name="transport_section_3">
                        </div>
                    </div>
                     <div class="inline-fields">
                        <div class="form-group">
                            <label for="transport_company_4">利用機関 会社・路線名4</label>
                            <input type="text" id="transport_company_4" name="transport_company_4">
                        </div>
                        <div class="form-group">
                            <label for="transport_section_4">利用区間4</label>
                            <input type="text" id="transport_section_4" name="transport_section_4">
                        </div>
                    </div>

                    <div class="inline-fields">
                        <div class="form-group">
                            <label for="round_trip_fare">一日往復運賃</label>
                            <input type="number" id="round_trip_fare" name="round_trip_fare" placeholder="例: 740">
                        </div>
                        <div class="form-group">
                            <label for="monthly_pass_fare">1ヶ月定期代</label>
                            <input type="number" id="monthly_pass_fare" name="monthly_pass_fare" placeholder="例: 14650">
                        </div>
                    </div>
                </div>

                <!-- 自転車選択の場合 -->
                <div id="commute_bicycle_section" class="commute-method-specific-section" style="display:none;">
                    <h3>自転車</h3>
                    <div class="inline-fields">
                        <div class="form-group">
                            <label for="bicycle_commute_method_detail">通勤手段詳細</label>
                            <select id="bicycle_commute_method_detail" name="bicycle_commute_method_detail">
                                <option value="">--選択してください--</option>
                                <option value="bicycle_only">自転車のみ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bicycle_start_date">利用開始日</label>
                            <input type="date" id="bicycle_start_date" name="bicycle_start_date">
                        </div>
                    </div>
                    <div class="inline-fields">
                        <div class="form-group">
                            <label for="bicycle_distance">通勤距離(片道)/km</label>
                            <input type="number" id="bicycle_distance" name="bicycle_distance" step="0.1" placeholder="例: 5.0">
                        </div>
                        <div class="form-group">
                            <label for="bicycle_duration">所要時間(片道)</label>
                            <input type="text" id="bicycle_duration" name="bicycle_duration" placeholder="例: 30分">
                        </div>
                    </div>
                </div>

                <!-- マイカー選択の場合 -->
                <div id="commute_car_section" class="commute-method-specific-section" style="display:none;">
                    <h3>マイカー</h3>
                    <div class="form-group">
                        <label for="car_route_map">通勤経路図 (ファイル添付)</label>
                        <input type="file" id="car_route_map" name="car_route_map">
                        <p class="description file-status">選択されていません (Google Maps表示も参考にしてください)</p>
                    </div>
                    <div class="form-group">
                        <label for="car_license_image">運転免許証画像</label>
                        <input type="file" id="car_license_image" name="car_license_image" accept="image/*">
                        <p class="description file-status">選択されていません</p>
                    </div>
                    <div class="form-group">
                        <label for="car_insurance_image">任意保険証画像</label>
                        <input type="file" id="car_insurance_image" name="car_insurance_image" accept="image/*">
                        <p class="description file-status">選択されていません</p>
                    </div>
                    <div class="form-group">
                        <button type="button" class="action-button-style modal-trigger-button" data-modal-target="#pledgeModal">誓約書を確認する</button>
                    </div>
                </div>

                <!-- バイク選択の場合 -->
                <div id="commute_motorcycle_section" class="commute-method-specific-section" style="display:none;">
                    <h3>バイク</h3>
                    <div class="form-group">
                        <label for="motorcycle_route_map">通勤経路図 (ファイル添付)</label>
                        <input type="file" id="motorcycle_route_map" name="motorcycle_route_map">
                        <p class="description file-status">選択されていません (Google Maps表示も参考にしてください)</p>
                    </div>
                    <div class="form-group">
                        <label for="motorcycle_license_image">運転免許証画像</label>
                        <input type="file" id="motorcycle_license_image" name="motorcycle_license_image" accept="image/*">
                        <p class="description file-status">選択されていません</p>
                    </div>
                    <div class="form-group">
                        <label for="motorcycle_insurance_image">任意保険証画像</label>
                        <input type="file" id="motorcycle_insurance_image" name="motorcycle_insurance_image" accept="image/*">
                        <p class="description file-status">選択されていません</p>
                    </div>
                    <div class="form-group">
                        <label for="motorcycle_compulsory_insurance_image">自賠責証明書画像</label>
                        <input type="file" id="motorcycle_compulsory_insurance_image" name="motorcycle_compulsory_insurance_image" accept="image/*">
                        <p class="description file-status">選択されていません</p>
                    </div>
                     <div class="form-group">
                        <button type="button" class="action-button-style modal-trigger-button" data-modal-target="#pledgeModal">誓約書を確認する</button>
                    </div>
                </div>

                <!-- 原付選択の場合 -->
                <div id="commute_moped_section" class="commute-method-specific-section" style="display:none;">
                    <h3>原付</h3>
                     <div class="form-group">
                        <label for="moped_route_map">通勤経路図 (ファイル添付)</label>
                        <input type="file" id="moped_route_map" name="moped_route_map">
                        <p class="description file-status">選択されていません (Google Maps表示も参考にしてください)</p>
                    </div>
                    <div class="form-group">
                        <label for="moped_license_image">運転免許証画像</label>
                        <input type="file" id="moped_license_image" name="moped_license_image" accept="image/*">
                        <p class="description file-status">選択されていません</p>
                    </div>
                    <div class="form-group">
                        <label for="moped_insurance_image">任意保険証画像 (任意)</label>
                        <input type="file" id="moped_insurance_image" name="moped_insurance_image" accept="image/*">
                        <p class="description file-status">選択されていません</p>
                    </div>
                    <div class="form-group">
                        <label for="moped_compulsory_insurance_image">自賠責証明書画像</label>
                        <input type="file" id="moped_compulsory_insurance_image" name="moped_compulsory_insurance_image" accept="image/*">
                        <p class="description file-status">選択されていません</p>
                    </div>
                     <div class="form-group">
                        <button type="button" class="action-button-style modal-trigger-button" data-modal-target="#pledgeModal">誓約書を確認する</button>
                    </div>
                </div>
            </fieldset>

            <!-- 給与支払口座 -->
            <fieldset class="form-section">
                <legend><h2>給与支払口座</h2></legend>
                <div class="form-group">
                    <label for="bank_book_image">通帳またはキャッシュカード(1)</label>
                    <input type="file" id="bank_book_image" name="bank_book_image">
                    <p class="description file-status">ご本人名義のもの。口座番号等情報と氏名が表裏で表記のある場合は、両面アップロードをお願いいたします。(選択されていません)</p>
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="bank_name">銀行名</label>
                        <input type="text" id="bank_name" name="bank_name" autocomplete="off" placeholder="例: 三菱UFJ銀行">
                        <div class="suggestion-box" id="bank_name_suggestions"></div>
                    </div>
                    <div class="form-group">
                        <label for="branch_name">支店名</label>
                        <input type="text" id="branch_name" name="branch_name" autocomplete="off" placeholder="例: 渋谷支店">
                        <div class="suggestion-box" id="branch_name_suggestions"></div>
                    </div>
                     <div class="form-group">
                        <label for="branch_code">支店コード</label>
                        <input type="text" id="branch_code" name="branch_code" placeholder="例: 001" readonly class="readonly-field">
                    </div>
                </div>
                <div class="inline-fields">
                     <div class="form-group">
                        <label for="account_type">預金種別</label>
                         <select id="account_type" name="account_type">
                            <option value="ordinary" selected>普通</option>
                            <option value="checking">当座</option>
                            <option value="savings">貯蓄</option>
                         </select>
                    </div>
                    <div class="form-group">
                        <label for="account_number">口座番号</label>
                        <input type="text" id="account_number" name="account_number" placeholder="例: 1234567">
                    </div>
                    <div class="form-group">
                        <label for="account_holder_name_kana">名義(カタカナ)</label>
                        <input type="text" id="account_holder_name_kana" name="account_holder_name_kana" placeholder="例: ヤマダ タロウ">
                    </div>
                </div>
            </fieldset>

            <div class="navigation-buttons">
                <span></span> <!-- Prev button placeholder -->
                <a href="page2.html" class="action-button-style next-btn">次へ (ステップ2へ)</a>
            </div>
        </form>
    </div>

    <!-- 誓約書確認モーダル (通勤手当用) -->
    <div id="pledgeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>誓約書</h3>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <p>私は、道路交通法、そのほか自動車関係法令並びに会社のマイカー関係規程を遵守し、常に安全運転に努め、決して会社にご迷惑をおかけしないことを誓約いたします。通勤に使用する車両は会社で規定する任意保険に加入し、申請に必要な書類を添付しております。</p>
                <hr>
                <p><strong>運転免許証画像を登録してください。</strong></p>
                <div class="image-preview-container">
                    <div class="form-group">
                        <input type="file" id="pledge_license_image_upload" name="pledge_license_image_upload" accept="image/*">
                        <p class="description file-status" id="pledge_license_file_status">選択されていません</p>
                    </div>
                    <div class="image-preview-box" id="pledge_license_preview_box">
                        <span id="pledge_license_preview_text">登録画像プレビュー</span>
                        <img src="#" alt="プレビュー" id="pledge_license_preview_img" style="display:none;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="pledgeModalRegisterButton" class="action-button-style">登録</button>
                 <button type="button" class="action-button-style close-modal-button" style="background-color:#6c757d; margin-left:10px;">閉じる</button>
            </div>
        </div>
    </div>

    <!-- (入社)雇用契約書 兼 雇入通知書 モーダル -->
    <div id="employmentContractModal" class="modal contract-agreement-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="employmentContractModalTitle">労働条件通知書 兼 雇用契約書</h3>
                <span class="close-button" data-modal-id="employmentContractModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="contract-viewer">
                    <img src="contract_pending_signature.png" alt="雇用契約書" id="employmentContract_image">
                </div>
                
                <div id="employmentContract_pre_agreement_content">
                    <p class="action-prompt">書類を確認のうえ、「合意に進む」を押してください。</p>
                    <div class="button-group">
                        <button type="button" class="action-btn reject-btn" data-contract-id="employmentContract">差し戻す</button>
                        <button type="button" class="action-btn agree-btn" data-contract-id="employmentContract">合意に進む</button>
                    </div>
                    <form id="employmentContract_agree_form" style="display:none;">
                         <div class="form-group">
                            <label for="employmentContract_signer_name">署名<span class="required-label">必須</span></label>
                            <input type="text" id="employmentContract_signer_name" name="signer_name" placeholder="例: 鈴木 一郎">
                            <span class="error-message" id="employmentContract_signer_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label>書類の受け取り方法<span class="required-label">必須</span></label>
                            <div class="checkbox-group agree-modal-body"> 
                                <input type="checkbox" id="employmentContract_agree_electronic_delivery" name="agree_electronic_delivery" checked>
                                <label for="employmentContract_agree_electronic_delivery">電子通知で受け取ることに同意する</label>
                            </div>
                            <span class="error-message" id="employmentContract_agree_delivery_error"></span>
                        </div>
                    </form>
                     <form id="employmentContract_reject_form" style="display:none;">
                        <div class="form-group">
                            <label for="employmentContract_reject_reason">差し戻し理由<span class="required-label">必須</span></label>
                            <textarea id="employmentContract_reject_reason" name="reject_reason" placeholder="差し戻しの理由を入力します"></textarea>
                            <span class="error-message" id="employmentContract_reject_reason_error"></span>
                        </div>
                    </form>
                </div>

                <div class="post-agreement-actions-modal" id="employmentContract_post_agreement_content">
                    <p class="action-prompt" style="color:green; font-weight:bold;">この書類は合意済みです。</p>
                    <div class="action-buttons-row-inner">
                        <button type="button" class="action-btn-small print-contract-btn">
                            <svg viewBox="0 0 20 20"><path d="M16 10c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1zM5 13h4c.55 0 1 .45 1 1s-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1zm12-8H3c-.55 0-1 .45-1 1v2H1c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1zm-1 10H2V7h1V4h14v9zM6 2h8v2H6V2z"/></svg>
                            印刷
                        </button>
                        <button type="button" class="action-btn-small download-contract-btn">
                            <svg viewBox="0 0 20 20"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
                            ダウンロード
                        </button>
                    </div>
                    <span class="checkbox-option">
                        <input type="checkbox" id="employmentContract_show_agreement_mark" checked>
                        <label for="employmentContract_show_agreement_mark">合意マークを表示する</label>
                    </span>
                </div>
            </div>
            <div class="modal-footer" id="employmentContract_modal_footer">
                <!-- JSでボタンを動的に設定 -->
            </div>
        </div>
    </div>

    <!-- 契約書 兼 身元保証書 モーダル -->
    <div id="guaranteeContractModal" class="modal contract-agreement-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="guaranteeContractModalTitle">契約書 兼 身元保証書</h3>
                <span class="close-button" data-modal-id="guaranteeContractModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="contract-viewer">
                    <img src="pledge-before-agreement.png" alt="身元保証書" id="guaranteeContract_image">
                </div>

                <div id="guaranteeContract_pre_agreement_content">
                    <p class="action-prompt">書類を確認のうえ、「合意に進む」を押してください。</p>
                    <div class="button-group">
                        <button type="button" class="action-btn reject-btn" data-contract-id="guaranteeContract">差し戻す</button>
                        <button type="button" class="action-btn agree-btn" data-contract-id="guaranteeContract">合意に進む</button>
                    </div>
                     <form id="guaranteeContract_agree_form" style="display:none;">
                         <div class="form-group">
                            <label for="guaranteeContract_signer_name">署名<span class="required-label">必須</span></label>
                            <input type="text" id="guaranteeContract_signer_name" name="signer_name" placeholder="例: 佐藤 花子">
                            <span class="error-message" id="guaranteeContract_signer_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label>書類の受け取り方法<span class="required-label">必須</span></label>
                            <div class="checkbox-group agree-modal-body">
                                <input type="checkbox" id="guaranteeContract_agree_electronic_delivery" name="agree_electronic_delivery" checked>
                                <label for="guaranteeContract_agree_electronic_delivery">電子通知で受け取ることに同意する</label>
                            </div>
                             <span class="error-message" id="guaranteeContract_agree_delivery_error"></span>
                        </div>
                    </form>
                    <form id="guaranteeContract_reject_form" style="display:none;">
                        <div class="form-group">
                            <label for="guaranteeContract_reject_reason">差し戻し理由<span class="required-label">必須</span></label>
                            <textarea id="guaranteeContract_reject_reason" name="reject_reason" placeholder="差し戻しの理由を入力します"></textarea>
                            <span class="error-message" id="guaranteeContract_reject_reason_error"></span>
                        </div>
                    </form>
                </div>
                <div class="post-agreement-actions-modal" id="guaranteeContract_post_agreement_content">
                     <p class="action-prompt" style="color:green; font-weight:bold;">この書類は合意済みです。</p>
                    <div class="action-buttons-row-inner">
                        <button type="button" class="action-btn-small print-contract-btn">
                            <svg viewBox="0 0 20 20"><path d="M16 10c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1zM5 13h4c.55 0 1 .45 1 1s-.45 1-1 1H5c-.55 0-1-.45-1-1s.45-1 1-1zm12-8H3c-.55 0-1 .45-1 1v2H1c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V6c0-.55-.45-1-1-1zm-1 10H2V7h1V4h14v9zM6 2h8v2H6V2z"/></svg>
                            印刷
                        </button>
                        <button type="button" class="action-btn-small download-contract-btn">
                            <svg viewBox="0 0 20 20"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
                            ダウンロード
                        </button>
                    </div>
                    <span class="checkbox-option">
                        <input type="checkbox" id="guaranteeContract_show_agreement_mark" checked>
                        <label for="guaranteeContract_show_agreement_mark">合意マークを表示する</label>
                    </span>
                </div>
            </div>
            <div class="modal-footer" id="guaranteeContract_modal_footer">
                <!-- JSでボタンを動的に設定 -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- START: Basic Info, Nationality, File Upload (partial), Pledge Modal JS ---
            const nationalityRadios = document.querySelectorAll('input[name="nationality"]');
            const residenceStatusGroup = document.getElementById('residence_status_group');
            const foreignDocumentsContainer = document.getElementById('foreign_documents_container');

            function updateFileStatusDisplay(fileInput, statusElement, deleteButton) {
                if (fileInput.files && fileInput.files.length > 0) {
                    statusElement.textContent = fileInput.files[0].name;
                    if (deleteButton) deleteButton.style.display = 'inline-block';
                    localStorage.setItem(fileInput.id + '_filename', fileInput.files[0].name);
                } else {
                    statusElement.textContent = statusElement.dataset.initialText || "選択されていません";
                    if (deleteButton) deleteButton.style.display = 'none';
                    localStorage.removeItem(fileInput.id + '_filename');
                }
            }
            
            // For general file inputs (non-"提出書類" section on this page)
            document.querySelectorAll('input[type="file"]').forEach(input => {
                // For this page, this applies to bank_book_image, car_route_map etc., and pledge_license_image_upload
                const parentContainer = input.closest('.form-group') || (input.id === 'pledge_license_image_upload' ? input.closest('.image-preview-container') : null);
                if (parentContainer) {
                    const statusElement = parentContainer.querySelector('.file-status:not(.file-upload-status-container .file-status)');
                    if (statusElement && !statusElement.dataset.initialText) { // Ensure not to double-handle if specific logic applies
                         statusElement.dataset.initialText = statusElement.textContent;
                    }
                }
                input.addEventListener('change', function() { 
                    let targetStatusElement = null;
                    const formGroup = this.closest('.form-group');
                     if (formGroup) {
                        targetStatusElement = formGroup.querySelector('.file-status:not(.file-upload-status-container .file-status)');
                    } else if (this.id === 'pledge_license_image_upload') { // Special case for pledge modal
                        targetStatusElement = document.getElementById('pledge_license_file_status');
                    }
                    
                    if (targetStatusElement) {
                        if (this.files && this.files.length > 0) {
                            targetStatusElement.textContent = this.files[0].name;
                            localStorage.setItem(this.id + '_filename', this.files[0].name);
                        } else {
                            targetStatusElement.textContent = targetStatusElement.dataset.initialText || "選択されていません";
                            localStorage.removeItem(this.id + '_filename');
                        }
                    }
                });

                // Load from localStorage on page load for these general file inputs
                const storedFilename = localStorage.getItem(input.id + '_filename');
                if (storedFilename) {
                    let targetStatusElement = null;
                    const formGroup = input.closest('.form-group');
                     if (formGroup) {
                        targetStatusElement = formGroup.querySelector('.file-status:not(.file-upload-status-container .file-status)');
                    } else if (input.id === 'pledge_license_image_upload') {
                        targetStatusElement = document.getElementById('pledge_license_file_status');
                    }
                    if (targetStatusElement) {
                        targetStatusElement.textContent = storedFilename;
                    }
                }
            });
            
            function createForeignerDocumentUploadBox(id, name, labelText, icon = '📄') {
                const docBox = document.createElement('div');
                docBox.className = 'document-box';
                docBox.id = `${id}_doc_box`;
                docBox.style.flexBasis = 'calc(50% - 5px)'; // For two columns
                const docIcon = document.createElement('span');
                docIcon.className = 'document-icon';
                docIcon.textContent = icon;
                docBox.appendChild(docIcon);
                const pLabel = document.createElement('p');
                const strongLabel = document.createElement('strong');
                strongLabel.textContent = labelText;
                pLabel.appendChild(strongLabel);
                docBox.appendChild(pLabel);
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file'; fileInput.id = id; fileInput.name = name; fileInput.style.display = 'none'; fileInput.accept = 'image/*,.pdf';
                docBox.appendChild(fileInput);

                const uploadLabel = document.createElement('label');
                uploadLabel.htmlFor = id; uploadLabel.className = 'upload-button-placeholder'; uploadLabel.textContent = 'アップロード';
                uploadLabel.style.marginTop = '5px'; uploadLabel.style.display = 'inline-block';
                docBox.appendChild(uploadLabel);
                
                const statusContainer = document.createElement('div');
                statusContainer.className = 'file-upload-status-container';

                const pStatus = document.createElement('span');
                pStatus.className = 'file-status'; pStatus.id = `${id}_file_status`; pStatus.textContent = '選択されていません';
                pStatus.dataset.initialText = '選択されていません';
                statusContainer.appendChild(pStatus);

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'delete-file-btn';
                deleteBtn.textContent = '削除';
                deleteBtn.dataset.targetId = id;
                deleteBtn.style.display = 'none';
                statusContainer.appendChild(deleteBtn);
                docBox.appendChild(statusContainer);

                const storedFilename = localStorage.getItem(id + '_filename');
                if (storedFilename) {
                    pStatus.textContent = storedFilename;
                    deleteBtn.style.display = 'inline-block';
                    uploadLabel.textContent = '変更';
                }

                fileInput.addEventListener('change', function() {
                    updateFileStatusDisplay(this, pStatus, deleteBtn); // Uses the global helper
                     if (this.files && this.files.length > 0) {
                        uploadLabel.textContent = '変更';
                    } else {
                        uploadLabel.textContent = 'アップロード';
                    }
                });
                deleteBtn.addEventListener('click', function() {
                    fileInput.value = ''; 
                    updateFileStatusDisplay(fileInput, pStatus, deleteBtn); // Uses the global helper
                    uploadLabel.textContent = 'アップロード';
                });
                return docBox;
            }

            if (residenceStatusGroup && foreignDocumentsContainer) {
                nationalityRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === 'foreign') {
                            residenceStatusGroup.style.display = 'block';
                            foreignDocumentsContainer.style.display = 'flex';
                            if (foreignDocumentsContainer.children.length === 0) { // Add only if not already added
                                foreignDocumentsContainer.appendChild(createForeignerDocumentUploadBox('residence_card_image', 'residence_card_image', '在留カード', '💳'));
                                foreignDocumentsContainer.appendChild(createForeignerDocumentUploadBox('passport_image', 'passport_image', 'パスポート', '🛂'));
                            }
                        } else {
                            residenceStatusGroup.style.display = 'none';
                            foreignDocumentsContainer.style.display = 'none';
                            // Optionally remove foreigner document boxes if nationality changes back, or just hide
                        }
                    });
                });
                // Trigger change on load to set initial state
                const checkedNationality = document.querySelector('input[name="nationality"]:checked');
                if (checkedNationality) {
                    checkedNationality.dispatchEvent(new Event('change'));
                }
            }
            
            const pledgeLicenseUpload = document.getElementById('pledge_license_image_upload');
            const pledgeLicensePreviewImg = document.getElementById('pledge_license_preview_img');
            const pledgeLicensePreviewText = document.getElementById('pledge_license_preview_text');
            if (pledgeLicenseUpload) { // Pledge modal is on this page
                pledgeLicenseUpload.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    const pledgeFileStatusEl = document.getElementById('pledge_license_file_status'); // Already handled by general file input listener for text
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            pledgeLicensePreviewImg.src = e.target.result;
                            pledgeLicensePreviewImg.style.display = 'block';
                            pledgeLicensePreviewText.style.display = 'none';
                        }
                        reader.readAsDataURL(file);
                    } else { 
                        resetPledgeModalPreview();
                    }
                });
                 const pledgeFileStatusEl = document.getElementById('pledge_license_file_status');
                 if(pledgeFileStatusEl && !pledgeFileStatusEl.dataset.initialText) pledgeFileStatusEl.dataset.initialText = pledgeFileStatusEl.textContent;
            }
            function resetPledgeModalPreview() {
                 if(pledgeLicenseUpload) pledgeLicenseUpload.value = '';
                 const pledgeFileStatus = document.getElementById('pledge_license_file_status');
                 if(pledgeFileStatus) pledgeFileStatus.textContent = pledgeFileStatus.dataset.initialText || '選択されていません';
                 if(pledgeLicensePreviewImg) { pledgeLicensePreviewImg.style.display = 'none'; pledgeLicensePreviewImg.src = '#'; }
                 if(pledgeLicensePreviewText) pledgeLicensePreviewText.style.display = 'block';
                 localStorage.removeItem('pledge_license_image_upload_filename');
            }
            const pledgeModalRegisterButton = document.getElementById('pledgeModalRegisterButton');
            if (pledgeModalRegisterButton) {
                pledgeModalRegisterButton.addEventListener('click', function() {
                    const fileInput = document.getElementById('pledge_license_image_upload');
                    if (fileInput.files.length > 0) {
                        alert('運転免許証画像を登録しました（ダミー）');
                        document.getElementById('pledgeModal').style.display = 'none';
                    } else { alert('運転免許証画像を選択してください。'); }
                });
            }
            // --- END: Basic Info, Nationality, File Upload (partial), Pledge Modal JS ---


            // --- START: Contract Document Modal Logic ---
            const contractDocumentBoxes = document.querySelectorAll('.clickable-document');
            const allModals = document.querySelectorAll('.modal'); // Includes pledgeModal, employmentContractModal, guaranteeContractModal

            function openModal(modalElement) { modalElement.style.display = 'flex'; } // Use flex for centering
            function closeModal(modalElement) {
                modalElement.style.display = 'none';
                if (modalElement.classList.contains('contract-agreement-modal')) {
                    const contractId = modalElement.id.replace('Modal', '');
                    // Reset forms only if not agreed, or if modal is being simply closed without submission
                    if (localStorage.getItem(`${contractId}_status`) !== 'agreed') {
                         resetContractModalForms(modalElement, contractId);
                    }
                }
            }
            function resetContractModalForms(modalElement, contractId) {
                const agreeForm = modalElement.querySelector(`#${contractId}_agree_form`);
                if (agreeForm) agreeForm.style.display = 'none';
                const rejectForm = modalElement.querySelector(`#${contractId}_reject_form`);
                if (rejectForm) rejectForm.style.display = 'none';
                
                ['signer_name', 'reject_reason'].forEach(field => {
                    const input = modalElement.querySelector(`#${contractId}_${field}`);
                    if (input) { input.value = ''; input.classList.remove('input-error'); }
                    const errorMsg = modalElement.querySelector(`#${contractId}_${field}_error`);
                    if (errorMsg) errorMsg.textContent = '';
                });
                const deliveryError = modalElement.querySelector(`#${contractId}_agree_delivery_error`);
                if (deliveryError) deliveryError.textContent = '';
                const deliveryCheckbox = modalElement.querySelector(`#${contractId}_agree_electronic_delivery`);
                if(deliveryCheckbox) deliveryCheckbox.checked = true; // Default to checked

                const preAgreementContent = modalElement.querySelector(`#${contractId}_pre_agreement_content`);
                if(preAgreementContent) {
                    const buttonGroup = preAgreementContent.querySelector('.button-group');
                    if(buttonGroup) buttonGroup.style.display = 'flex'; // Show initial agree/reject buttons
                }
                updateModalFooter(modalElement, contractId, 'initial');
            }

            contractDocumentBoxes.forEach(box => { // For employmentContract and guaranteeContract
                box.addEventListener('click', function() {
                    const modalId = this.dataset.modalTarget;
                    const contractId = this.dataset.contractId;
                    const modalElement = document.querySelector(modalId);
                    if (modalElement) { 
                        loadContractModalState(modalElement, contractId); // Load state before opening
                        openModal(modalElement); 
                    }
                });
            });
             // For Pledge Modal (and any other modal triggered by .modal-trigger-button)
            document.querySelectorAll('.modal-trigger-button').forEach(button => {
                button.addEventListener('click', function() {
                    const modalId = this.dataset.modalTarget;
                    const modalElement = document.querySelector(modalId);
                    if (modalElement) openModal(modalElement);
                });
            });

            document.querySelectorAll('.modal .close-button').forEach(button => { // General close buttons
                button.addEventListener('click', function() { closeModal(this.closest('.modal')); });
            });
            document.querySelectorAll('#pledgeModal .close-modal-button').forEach(button => { // Specific close button in pledge modal footer
                 button.addEventListener('click', function() { this.closest('.modal').style.display = 'none'; });
            });

            window.addEventListener('click', function(event) {
                allModals.forEach(modal => { if (event.target === modal) { closeModal(modal); } });
            });

            function loadContractModalState(modalElement, contractId) {
                const contractStatus = localStorage.getItem(`${contractId}_status`) || 'pending';
                const contractImageElement = modalElement.querySelector(`#${contractId}_image`);
                const preAgreementContent = modalElement.querySelector(`#${contractId}_pre_agreement_content`);
                const postAgreementContent = modalElement.querySelector(`#${contractId}_post_agreement_content`);
                
                const agreeForm = modalElement.querySelector(`#${contractId}_agree_form`);
                const rejectForm = modalElement.querySelector(`#${contractId}_reject_form`);
                const buttonGroup = preAgreementContent.querySelector('.button-group');

                if(agreeForm) agreeForm.style.display = 'none';
                if(rejectForm) rejectForm.style.display = 'none';
                if(buttonGroup) buttonGroup.style.display = 'flex'; // Reset to initial state

                let imgSrc = '';
                if (contractId === 'employmentContract') {
                    imgSrc = (contractStatus === 'agreed') ? 'contract_signed.png' : 'contract_pending_signature.png';
                } else if (contractId === 'guaranteeContract') {
                    imgSrc = (contractStatus === 'agreed') ? 'pledge-after-agreement.png' : 'pledge-before-agreement.png';
                }
                contractImageElement.src = imgSrc;


                if (contractStatus === 'agreed') {
                    preAgreementContent.style.display = 'none';
                    postAgreementContent.style.display = 'flex';
                    updateModalFooter(modalElement, contractId, 'agreed');
                } else { // pending or rejected
                    preAgreementContent.style.display = 'block'; 
                    postAgreementContent.style.display = 'none';
                    updateModalFooter(modalElement, contractId, 'initial'); 
                }
            }

            function updateModalFooter(modalElement, contractId, state) {
                const footer = modalElement.querySelector(`#${contractId}_modal_footer`);
                footer.innerHTML = ''; // Clear existing buttons

                if (state === 'agree_form') {
                    footer.innerHTML = `<button type="button" class="action-btn btn-secondary" data-action="cancel_agree" data-contract-id="${contractId}">キャンセル</button><button type="button" class="action-btn agree-btn" data-action="submit_agree" data-contract-id="${contractId}">合意する</button>`;
                } else if (state === 'reject_form') {
                     footer.innerHTML = `<button type="button" class="action-btn btn-secondary" data-action="cancel_reject" data-contract-id="${contractId}">キャンセル</button><button type="button" class="action-btn reject-btn submit" data-action="submit_reject" data-contract-id="${contractId}">差し戻す</button>`;
                } else if (state === 'agreed') {
                    footer.innerHTML = `<button type="button" class="action-btn btn-secondary" data-action="close" data-contract-id="${contractId}">閉じる</button>`;
                } else { // initial or rejected (from a display perspective)
                     footer.innerHTML = `<button type="button" class="action-btn btn-secondary" data-action="close" data-contract-id="${contractId}">閉じる</button>`;
                }
                // Re-attach event listeners to new buttons
                footer.querySelectorAll('button').forEach(btn => { btn.addEventListener('click', handleModalFooterAction); });
            }

            function handleModalFooterAction(event) {
                const action = event.target.dataset.action;
                const contractId = event.target.dataset.contractId;
                const modalElement = document.getElementById(`${contractId}Modal`);
                
                const agreeForm = modalElement.querySelector(`#${contractId}_agree_form`);
                const rejectForm = modalElement.querySelector(`#${contractId}_reject_form`);
                const buttonGroup = modalElement.querySelector(`#${contractId}_pre_agreement_content .button-group`);

                if (action === 'cancel_agree' || action === 'cancel_reject') {
                    if(agreeForm) agreeForm.style.display = 'none';
                    if(rejectForm) rejectForm.style.display = 'none';
                    if(buttonGroup) buttonGroup.style.display = 'flex';
                    updateModalFooter(modalElement, contractId, 'initial');
                } else if (action === 'submit_agree') { submitAgreement(modalElement, contractId);
                } else if (action === 'submit_reject') { submitRejection(modalElement, contractId);
                } else if (action === 'close') { closeModal(modalElement); }
            }

            // Initial event listeners for agree/reject buttons within pre_agreement_content
            modalEventListeners('add'); 

            function modalEventListeners(actionType) { // 'add' or 'remove'
                 document.querySelectorAll('.contract-agreement-modal .agree-btn, .contract-agreement-modal .reject-btn').forEach(button => {
                    // Ensure we are targeting buttons within the pre_agreement_content, not the footer
                    if (button.closest && button.closest(`#${button.dataset.contractId}_pre_agreement_content`)) {
                        const handler = (event) => handlePreAgreementActions(event, button.classList.contains('agree-btn') ? 'agree' : 'reject');
                        if (actionType === 'add') {
                            button.removeEventListener('click', handler); // Prevent multiple listeners if re-called
                            button.addEventListener('click', handler);
                        } else { // remove (not strictly needed here but good practice)
                            button.removeEventListener('click', handler);
                        }
                    }
                });
            }
            
            function handlePreAgreementActions(event, type) {
                const contractId = event.target.dataset.contractId;
                const modalElement = document.getElementById(`${contractId}Modal`);
                const agreeForm = modalElement.querySelector(`#${contractId}_agree_form`);
                const rejectForm = modalElement.querySelector(`#${contractId}_reject_form`);
                const buttonGroup = modalElement.querySelector(`#${contractId}_pre_agreement_content .button-group`);
                
                buttonGroup.style.display = 'none'; // Hide initial agree/reject buttons

                if (type === 'agree') {
                    agreeForm.style.display = 'block'; rejectForm.style.display = 'none';
                    updateModalFooter(modalElement, contractId, 'agree_form');
                } else if (type === 'reject') {
                    rejectForm.style.display = 'block'; agreeForm.style.display = 'none';
                    updateModalFooter(modalElement, contractId, 'reject_form');
                }
            }

            function submitAgreement(modalElement, contractId) {
                const signerNameInput = modalElement.querySelector(`#${contractId}_signer_name`);
                const deliveryCheckbox = modalElement.querySelector(`#${contractId}_agree_electronic_delivery`);
                const signerError = modalElement.querySelector(`#${contractId}_signer_name_error`);
                const deliveryError = modalElement.querySelector(`#${contractId}_agree_delivery_error`);
                let isValid = true;

                signerError.textContent = ''; deliveryError.textContent = ''; signerNameInput.classList.remove('input-error');

                if (signerNameInput.value.trim() === '') {
                    signerError.textContent = '氏名を入力してください。'; signerNameInput.classList.add('input-error'); isValid = false;
                }
                if (!deliveryCheckbox.checked) {
                    deliveryError.textContent = '電子通知での受け取りに同意してください。'; isValid = false;
                }

                if (isValid) {
                    localStorage.setItem(`${contractId}_status`, 'agreed');
                    localStorage.setItem(`${contractId}_signer_name`, signerNameInput.value.trim());
                    // Update main page status display
                    const mainDocStatus = document.getElementById(`${contractId}Status`);
                    mainDocStatus.textContent = '（合意済）'; mainDocStatus.className = 'contract-status status-agreed';
                    document.getElementById(`${contractId}PostActions`).style.display = 'flex';

                    alert(`${modalElement.querySelector('h3').textContent} に合意しました。`);
                    loadContractModalState(modalElement, contractId); // Refresh modal to show post-agreement content
                }
            }

            function submitRejection(modalElement, contractId) {
                const rejectReasonInput = modalElement.querySelector(`#${contractId}_reject_reason`);
                const reasonError = modalElement.querySelector(`#${contractId}_reject_reason_error`);
                let isValid = true;
                reasonError.textContent = ''; rejectReasonInput.classList.remove('input-error');

                if (rejectReasonInput.value.trim() === '') {
                    reasonError.textContent = '差し戻し理由を入力してください。'; rejectReasonInput.classList.add('input-error'); isValid = false;
                }

                if (isValid) {
                    localStorage.setItem(`${contractId}_status`, 'rejected');
                    localStorage.setItem(`${contractId}_reject_reason`, rejectReasonInput.value.trim());
                    // Update main page status display
                    const mainDocStatus = document.getElementById(`${contractId}Status`);
                    mainDocStatus.textContent = '（差戻済）'; mainDocStatus.className = 'contract-status status-rejected';
                    document.getElementById(`${contractId}PostActions`).style.display = 'none';
                    
                    alert(`${modalElement.querySelector('h3').textContent} を差し戻しました。`);
                    closeModal(modalElement); // Close modal after rejection
                }
            }

            // Load initial status for contract documents on the main page
            contractDocumentBoxes.forEach(box => {
                const contractId = box.dataset.contractId;
                const status = localStorage.getItem(`${contractId}_status`);
                const mainDocStatus = document.getElementById(`${contractId}Status`);
                const postActions = document.getElementById(`${contractId}PostActions`);

                if (status === 'agreed') {
                    mainDocStatus.textContent = '（合意済）'; mainDocStatus.className = 'contract-status status-agreed'; postActions.style.display = 'flex';
                } else if (status === 'rejected') {
                    mainDocStatus.textContent = '（差戻済）'; mainDocStatus.className = 'contract-status status-rejected'; postActions.style.display = 'none';
                } else { // pending or null
                    mainDocStatus.textContent = '（未合意）'; mainDocStatus.className = 'contract-status status-pending'; postActions.style.display = 'none';
                }
            });

            document.querySelectorAll('.print-contract-btn').forEach(btn => {
                btn.addEventListener('click', () => alert('印刷処理を実行します。（ダミー）'));
            });
            document.querySelectorAll('.download-contract-btn').forEach(btn => {
                btn.addEventListener('click', () => alert('ダウンロード処理を実行します。（ダミー）'));
            });
            document.querySelectorAll('.post-agreement-actions-modal input[type="checkbox"]').forEach(cb => { // For "合意マークを表示する"
                 cb.addEventListener('change', function() { alert(this.checked ? '合意マークを表示します。（ダミー）' : '合意マークを非表示にします。（ダミー）'); });
            });
             // Add input event listeners to clear errors on input
            ['signer_name', 'reject_reason'].forEach(fieldPrefix => {
                ['employmentContract', 'guaranteeContract'].forEach(contractId => {
                    const input = document.getElementById(`${contractId}_${fieldPrefix}`);
                    const errorSpan = document.getElementById(`${contractId}_${fieldPrefix}_error`);
                    if (input && errorSpan) {
                        input.addEventListener('input', function() { if (this.classList.contains('input-error')) { this.classList.remove('input-error'); errorSpan.textContent = ''; } });
                    }
                });
            });
             ['employmentContract', 'guaranteeContract'].forEach(contractId => {
                const checkbox = document.getElementById(`${contractId}_agree_electronic_delivery`);
                const errorSpan = document.getElementById(`${contractId}_agree_delivery_error`);
                if(checkbox && errorSpan){ checkbox.addEventListener('change', function(){ if(this.checked) errorSpan.textContent = ''; }); }
            });
            // --- END: Contract Document Modal Logic ---


            // --- START: Commute Allowance Section Logic ---
            const commuteMethodRadios = document.querySelectorAll('input[name="commute_method"]');
            const commuteSections = {
                public_transport: document.getElementById('commute_public_transport_section'),
                bicycle: document.getElementById('commute_bicycle_section'),
                car: document.getElementById('commute_car_section'),
                motorcycle: document.getElementById('commute_motorcycle_section'),
                moped: document.getElementById('commute_moped_section'),
                walk: null 
            };
            const commuteRouteMapDisplayArea = document.getElementById('commute_route_map_display_area');
            const googleMapsIframe = document.getElementById('google_maps_route_iframe');
            const reflectRouteInfoBtn = document.getElementById('reflect_route_info_btn');
            const officeAddress = "東京都千代田区大手町1－1－3"; 

            function getFullCurrentAddressForCommute() { 
                const prefecture = document.getElementById('prefecture').value.trim();
                const city = document.getElementById('city').value.trim();
                const line1 = document.getElementById('address_line1').value.trim();
                if (prefecture && city && line1) {
                    return `${prefecture}${city}${line1}`;
                }
                return null;
            }
            function updateGoogleMapsRoute() {
                const currentAddress = getFullCurrentAddressForCommute(); 
                const selectedCommuteMethodRadio = document.querySelector('input[name="commute_method"]:checked');
                if (!selectedCommuteMethodRadio) return; // No method selected
                const selectedCommuteMethod = selectedCommuteMethodRadio.value;

                let dirflg = '';
                switch (selectedCommuteMethod) {
                    case 'public_transport': dirflg = 'r'; break; case 'bicycle': dirflg = 'b'; break;
                    case 'car': case 'motorcycle': case 'moped': dirflg = 'c'; break;
                    case 'walk': dirflg = 'w'; break; default: dirflg = '';
                }
                if (currentAddress && dirflg) {
                    const encodedCurrentAddress = encodeURIComponent(currentAddress);
                    const encodedOfficeAddress = encodeURIComponent(officeAddress);
                    googleMapsIframe.src = `https://maps.google.co.jp/maps?output=embed&saddr=${encodedCurrentAddress}&daddr=${encodedOfficeAddress}&dirflg=${dirflg}`;
                    commuteRouteMapDisplayArea.style.display = 'block';
                    reflectRouteInfoBtn.style.display = (selectedCommuteMethod === 'public_transport' || selectedCommuteMethod === 'bicycle') ? 'inline-block' : 'none';
                } else {
                    if (!currentAddress) { // If address is incomplete, hide map
                        googleMapsIframe.src = 'about:blank'; 
                        commuteRouteMapDisplayArea.style.display = 'none'; 
                        reflectRouteInfoBtn.style.display = 'none';
                    } else if (selectedCommuteMethod === 'walk' && dirflg === 'w') { // Special handling for walk if address is present
                         const encodedCurrentAddress = encodeURIComponent(currentAddress);
                        const encodedOfficeAddress = encodeURIComponent(officeAddress);
                        googleMapsIframe.src = `https://maps.google.co.jp/maps?output=embed&saddr=${encodedCurrentAddress}&daddr=${encodedOfficeAddress}&dirflg=w`;
                        commuteRouteMapDisplayArea.style.display = 'block';
                        reflectRouteInfoBtn.style.display = 'none'; // No reflect button for walk
                    }
                }
            }
            function updateCommuteSectionsDisplayAndMap() { 
                const selectedCommuteMethodRadio = document.querySelector('input[name="commute_method"]:checked');
                if (!selectedCommuteMethodRadio) { // If nothing is checked (e.g. on initial load before default kicks in)
                     Object.values(commuteSections).forEach(section => { if(section) section.style.display = 'none'; });
                     commuteRouteMapDisplayArea.style.display = 'none';
                     return;
                }
                const selectedValue = selectedCommuteMethodRadio.value;
                for (const key in commuteSections) {
                    if (commuteSections[key]) commuteSections[key].style.display = (key === selectedValue) ? 'block' : 'none';
                }
                updateGoogleMapsRoute();
            }
            commuteMethodRadios.forEach(radio => { radio.addEventListener('change', updateCommuteSectionsDisplayAndMap); });
            ['prefecture', 'city', 'address_line1'].forEach(id => {
                const field = document.getElementById(id);
                if (field) field.addEventListener('blur', updateGoogleMapsRoute); // Update map when address fields lose focus
            });
            if(reflectRouteInfoBtn) {
                reflectRouteInfoBtn.addEventListener('click', function() {
                    const selectedCommuteMethodRadio = document.querySelector('input[name="commute_method"]:checked');
                    if (!selectedCommuteMethodRadio) return;
                    const selectedCommuteMethod = selectedCommuteMethodRadio.value;

                    // Clear previous public transport details
                    for(let i = 1; i <= 4; i++) {
                        const companyInput = document.getElementById(`transport_company_${i}`);
                        const sectionInput = document.getElementById(`transport_section_${i}`);
                        if(companyInput) companyInput.value = '';
                        if(sectionInput) sectionInput.value = '';
                    }
                    
                    let newDistance, newDuration, newRoundTrip, newMonthlyPass, newCompany1, newSection1, newCompany2, newSection2;
                    const currentAddress = getFullCurrentAddressForCommute() || "default"; // Use a default if address is missing
                    // Simple hash from address to vary dummy data
                    let addressHash = 0;
                    for (let i = 0; i < currentAddress.length; i++) {
                        addressHash = (addressHash << 5) - addressHash + currentAddress.charCodeAt(i);
                        addressHash |= 0; // Convert to 32bit integer
                    }

                    if (selectedCommuteMethod === 'public_transport') {
                        newDistance = (10 + (Math.abs(addressHash) % 10)).toFixed(1); // km
                        newDuration = (50 + (Math.abs(addressHash) % 20)) + '分';    
                        newRoundTrip = 740 + (Math.abs(addressHash) % 5) * 20; // Yen
                        newMonthlyPass = 14650 + (Math.abs(addressHash) % 10) * 100; // Yen
                        newCompany1 = (Math.abs(addressHash) % 3 === 0) ? 'JR総武線' : (Math.abs(addressHash) % 3 === 1) ? '京王線' : '東急東横線';
                        newSection1 = '自宅最寄駅(仮) - 乗換駅X(仮)';
                        newCompany2 = (Math.abs(addressHash) % 2 === 0) ? '東京メトロ銀座線' : '都営三田線';
                        newSection2 = '乗換駅X(仮) - 大手町駅(仮)';
                        
                        document.getElementById('public_distance').value = newDistance;
                        document.getElementById('public_duration').value = newDuration;
                        document.getElementById('round_trip_fare').value = newRoundTrip;
                        document.getElementById('monthly_pass_fare').value = newMonthlyPass;
                        document.getElementById('transport_company_1').value = newCompany1;
                        document.getElementById('transport_section_1').value = newSection1;
                        document.getElementById('transport_company_2').value = newCompany2;
                        document.getElementById('transport_section_2').value = newSection2;

                        console.log("公共交通の経路情報をフォームに反映しました（現住所に基づく新しいダミーデータ）。");
                    } else if (selectedCommuteMethod === 'bicycle') {
                        newDistance = (5 + (Math.abs(addressHash) % 5)).toFixed(1); // km
                        newDuration = (25 + (Math.abs(addressHash) % 15)) + '分';
                        document.getElementById('bicycle_distance').value = newDistance; 
                        document.getElementById('bicycle_duration').value = newDuration;
                        console.log("自転車の経路情報をフォームに反映しました（現住所に基づく新しいダミーデータ）。");
                    }
                });
            }
            updateCommuteSectionsDisplayAndMap(); // Initial call to set display based on checked radio
            // --- END: Commute Allowance Section Logic ---

            // --- START: Postal Code Auto-Address and Formatting Logic ---
            function formatPostalCode(inputElement) {
                let value = inputElement.value.replace(/[^0-9]/g, ""); 
                if (value.length > 3) { value = value.substring(0, 3) + "-" + value.substring(3); }
                if (value.length > 8) { value = value.substring(0, 8); } // Max length for "XXX-XXXX"
                inputElement.value = value;
            }
            async function fetchAddressFromPostalCode(postalCode, prefix) {
                const pc = postalCode.replace(/-/g, ''); 
                if (pc.length !== 7) { alert('有効な郵便番号を7桁で入力してください。'); return; }
                try {
                    const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${pc}`);
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    const data = await response.json();
                    if (data.status === 200 && data.results) {
                        const result = data.results[0];
                        document.getElementById(`${prefix}prefecture`).value = result.address1 || '';
                        document.getElementById(`${prefix}city`).value = result.address2 || '';
                        document.getElementById(`${prefix}address_line1`).value = result.address3 || '';
                        // If it's the main address, update the commute map
                        if (prefix === '') { updateGoogleMapsRoute(); } 
                    } else { alert(`住所が見つかりませんでした: ${data.message || ''}`); }
                } catch (error) { console.error('住所検索エラー:', error); alert('住所の検索中にエラーが発生しました。'); }
            }
            const postalCodeInput = document.getElementById('postal_code');
            const searchAddressBtn = document.getElementById('search_address_btn');
            const emergencyPostalCodeInput = document.getElementById('emergency_postal_code');
            const searchEmergencyAddressBtn = document.getElementById('search_emergency_address_btn');

            if (postalCodeInput) { postalCodeInput.addEventListener('input', () => formatPostalCode(postalCodeInput)); postalCodeInput.addEventListener('blur', () => formatPostalCode(postalCodeInput)); }
            if (searchAddressBtn && postalCodeInput) { searchAddressBtn.addEventListener('click', () => fetchAddressFromPostalCode(postalCodeInput.value, '')); }
            
            if (emergencyPostalCodeInput) { emergencyPostalCodeInput.addEventListener('input', () => formatPostalCode(emergencyPostalCodeInput)); emergencyPostalCodeInput.addEventListener('blur', () => formatPostalCode(emergencyPostalCodeInput));}
            if (searchEmergencyAddressBtn && emergencyPostalCodeInput) { searchEmergencyAddressBtn.addEventListener('click', () => fetchAddressFromPostalCode(emergencyPostalCodeInput.value, 'emergency_')); }
            // --- END: Postal Code Auto-Address and Formatting Logic ---

            // --- START: Bank Info Suggestion Logic ---
            const bankNameInput = document.getElementById('bank_name');
            const bankNameSuggestionsBox = document.getElementById('bank_name_suggestions');
            const branchNameInput = document.getElementById('branch_name');
            const branchNameSuggestionsBox = document.getElementById('branch_name_suggestions');
            const branchCodeInput = document.getElementById('branch_code');

            const dummyBanks = [ // Sample data
                { name: "三菱UFJ銀行", code: "0005", branches: [{name: "本店", code: "001"}, {name: "渋谷支店", code: "135"}, {name: "新宿支店", code: "300"}, {name: "オンライン支店", code: "777"}] },
                { name: "三井住友銀行", code: "0009", branches: [{name: "本店営業部", code: "600"}, {name: "池袋支店", code: "261"}, {name: "神戸営業部", code: "400"}] },
                { name: "みずほ銀行", code: "0001", branches: [{name: "丸之内支店", code: "002"}, {name: "銀座支店", code: "020"}, {name: "インターネット支店", code: "686"}] },
                { name: "ゆうちょ銀行", code: "9900", branches: [{name: "本店", code: "019"}, {name: "〇一八支店", code: "018"}, {name: "二一八支店", code: "218"}] },
                { name: "楽天銀行", code: "0036", branches: [{name: "ジャズ支店", code: "201"}, {name: "ロック支店", code: "202"}, {name: "サンバ支店", code: "203"}] }
            ];

            function showSuggestions(inputElement, suggestionBox, items, itemKey = 'name') {
                suggestionBox.innerHTML = '';
                if (items.length > 0) {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item[itemKey];
                        div.addEventListener('click', () => {
                            inputElement.value = item[itemKey];
                            suggestionBox.style.display = 'none';
                            suggestionBox.innerHTML = '';
                            
                            if (inputElement.id === 'bank_name') {
                                branchNameInput.value = ''; // Clear branch name
                                branchCodeInput.value = ''; // Clear branch code
                                branchNameInput.focus(); // Focus on branch name for next input
                            } else if (inputElement.id === 'branch_name') {
                                branchCodeInput.value = item.code || 'XXX'; // Fill branch code
                            }
                        });
                        suggestionBox.appendChild(div);
                    });
                    suggestionBox.style.display = 'block';
                } else {
                    suggestionBox.style.display = 'none';
                }
            }
            
            if (bankNameInput && bankNameSuggestionsBox) {
                bankNameInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    const filteredBanks = dummyBanks.filter(bank => bank.name.toLowerCase().includes(query));
                    showSuggestions(this, bankNameSuggestionsBox, filteredBanks, 'name');
                });
                bankNameInput.addEventListener('blur', function() { 
                    // Delay hiding to allow click on suggestion
                    setTimeout(() => { if (!bankNameSuggestionsBox.contains(document.activeElement)) bankNameSuggestionsBox.style.display = 'none'; }, 150);
                });
            }

            if (branchNameInput && branchNameSuggestionsBox && bankNameInput && branchCodeInput) {
                branchNameInput.addEventListener('input', function() {
                    const selectedBankName = bankNameInput.value;
                    const bankData = dummyBanks.find(b => b.name === selectedBankName);
                    if (bankData && bankData.branches) {
                        const query = this.value.toLowerCase();
                        const filteredBranches = bankData.branches.filter(branch => branch.name.toLowerCase().includes(query));
                        showSuggestions(this, branchNameSuggestionsBox, filteredBranches, 'name');
                    } else {
                        branchNameSuggestionsBox.style.display = 'none'; // Hide if no bank selected or no branches
                        branchCodeInput.value = ''; // Clear branch code if bank is not valid
                    }
                });
                 branchNameInput.addEventListener('blur', function() { 
                    setTimeout(() => { if (!branchNameSuggestionsBox.contains(document.activeElement)) branchNameSuggestionsBox.style.display = 'none'; }, 150);
                });
            }
            // --- END: Bank Info Suggestion Logic ---
            
            // --- START: Devtool buttons ---
            const devFillFormBtn = document.getElementById('dev_fill_form_btn');
            const devResetFormBtn = document.getElementById('dev_reset_form_btn');
            const devClearStorageBtn = document.getElementById('dev_clear_storage_btn');

            if(devFillFormBtn) {
                devFillFormBtn.addEventListener('click', () => {
                    // Fill fields relevant to page 1
                    document.getElementById('last_name').value = '開発';
                    document.getElementById('first_name').value = '花子';
                    document.getElementById('last_name_kana').value = 'カイハツ';
                    document.getElementById('first_name_kana').value = 'ハナコ';
                    document.getElementById('gender').value = 'female';
                    document.getElementById('birth_date').value = '1995-05-15';
                    document.getElementById('mobile_phone_number').value = '090-9876-5432';
                    document.getElementById('email').value = 'hanako.dev@example.com';
                    document.getElementById('postal_code').value = '150-0002';
                    fetchAddressFromPostalCode('150-0002', '').then(() => { // Ensure address is fetched before filling line2
                        document.getElementById('address_line2').value = 'テストアパート303';
                        document.getElementById('address_kana').value = 'トウキョウトシブヤクシブヤ';
                    });
                    document.getElementById('emergency_last_name').value = '開発';
                    document.getElementById('emergency_first_name').value = '一郎';
                    document.getElementById('emergency_relationship').value = 'sibling';
                    document.getElementById('bank_name').value = '三菱UFJ銀行';
                    document.getElementById('branch_name').value = '渋谷支店';
                    document.getElementById('branch_code').value = '135';
                    document.getElementById('account_number').value = '1234567';
                    document.getElementById('account_holder_name_kana').value = 'カイハツ ハナコ';
                    
                    console.log("テストデータがページ1の項目に入力されました。");
                });
            }
            if(devResetFormBtn) {
                 devResetFormBtn.addEventListener('click', () => {
                    document.getElementById('onboardingFormPage1').reset();
                     // Manually clear fields not reset by form.reset() or specific to page 1 logic
                    document.querySelectorAll('.file-status').forEach(el => {
                        el.textContent = el.dataset.initialText || "選択されていません";
                        // Note: Delete buttons for foreigner docs are dynamically added, might need specific handling if they persist across reset
                    });
                     if(foreignDocumentsContainer) foreignDocumentsContainer.innerHTML = ''; // Clear dynamic foreigner docs
                     if(googleMapsIframe) googleMapsIframe.src = 'about:blank';
                     if(commuteRouteMapDisplayArea) commuteRouteMapDisplayArea.style.display = 'none';
                     if(reflectRouteInfoBtn) reflectRouteInfoBtn.style.display = 'none';
                     resetPledgeModalPreview();
                     updateCommuteSectionsDisplayAndMap(); // Reset commute section display

                    console.log("ページ1のフォーム入力がリセットされました。");
                });
            }
            if(devClearStorageBtn) {
                devClearStorageBtn.addEventListener('click', () => {
                    localStorage.clear();
                    alert('LocalStorageがクリアされました。ページを再読み込みします。');
                    window.location.reload();
                });
            }
            // --- END: Devtool buttons ---
        });
    </script>
</body>
</html>